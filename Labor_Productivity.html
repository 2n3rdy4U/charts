<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        html, body {{
            width: 100%;
            height: 100%;
            overflow: hidden;
        }}
        #vis {{
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }}
        #vis .vega-embed {{
            width: 100% !important;
            flex: 1;
        }}
        #vis .vega-embed details {{
            position: absolute;
            right: 5px;
            top: 5px;
        }}
        /* Style the radio buttons */
        .vega-bindings {{
            padding: 5px 0 10px 0;
            font-family: Georgia, serif;
            font-size: 13px;
        }}
        .vega-bind {{
            padding: 2px 0;
        }}
        .vega-bind-name {{
            font-weight: normal;
            color: #555;
        }}
        .vega-bind input[type="radio"] {{
            margin: 0 3px 0 8px;
        }}
        /* Preset buttons */
        #preset-buttons button {
            background: #fff;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: Georgia, serif;
            color: #2c3e50;
        }
        #preset-buttons button.active {
            background: #2E86AB;
            color: white;
            border-color: #2E86AB;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
    <div id="controls" style="padding:8px 0 12px 0; font-family: Georgia, serif; display:flex; gap:8px; align-items:center;">
        <div id="preset-buttons">
            <button data-range="1">1M</button>
            <button data-range="3">3M</button>
            <button data-range="12">1Y</button>
            <button data-range="60">5Y</button>
            <button data-range="all">All</button>
        </div>
        <span id="range-label" style="margin-left:12px;color:#555;font-size:13px;"></span>
    </div>
    <div id="vis"></div>
    <script>
        const originalSpec = {
  "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
  "config": {
    "axisX": {
      "grid": false,
      "labelFont": "Georgia, serif",
      "titleFont": "Georgia, serif"
    },
    "axisY": {
      "grid": true,
      "labelFont": "Georgia, serif",
      "titleFont": "Georgia, serif"
    },
    "title": {
      "font": "Georgia, serif"
    },
    "view": {
      "continuousHeight": 300,
      "continuousWidth": 300
    }
  },
  "data": {
    "name": "data-b2102627879a63c6723a978a6f5ddce0"
  },
  "datasets": {
    "data-b2102627879a63c6723a978a6f5ddce0": [
      {
        "date": "2016-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 98.205
      },
      {
        "date": "2016-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 98.267
      },
      {
        "date": "2016-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 98.603
      },
      {
        "date": "2016-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 99.271
      },
      {
        "date": "2017-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 99.432
      },
      {
        "date": "2017-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 99.485
      },
      {
        "date": "2017-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 100.294
      },
      {
        "date": "2017-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 101.031
      },
      {
        "date": "2018-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 101.359
      },
      {
        "date": "2018-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 101.372
      },
      {
        "date": "2018-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 101.668
      },
      {
        "date": "2018-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 101.486
      },
      {
        "date": "2019-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 102.341
      },
      {
        "date": "2019-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 102.97
      },
      {
        "date": "2019-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 104.128
      },
      {
        "date": "2019-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 105.102
      },
      {
        "date": "2020-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 104.679
      },
      {
        "date": "2020-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 109.773
      },
      {
        "date": "2020-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 111.492
      },
      {
        "date": "2020-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 110.598
      },
      {
        "date": "2021-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 111.418
      },
      {
        "date": "2021-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 111.595
      },
      {
        "date": "2021-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 110.997
      },
      {
        "date": "2021-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 111.648
      },
      {
        "date": "2022-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 110.202
      },
      {
        "date": "2022-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 109.361
      },
      {
        "date": "2022-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 109.443
      },
      {
        "date": "2022-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 110.012
      },
      {
        "date": "2023-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 110.309
      },
      {
        "date": "2023-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 111.38
      },
      {
        "date": "2023-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 112.802
      },
      {
        "date": "2023-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 113.857
      },
      {
        "date": "2024-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 114.006
      },
      {
        "date": "2024-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 114.855
      },
      {
        "date": "2024-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 115.74
      },
      {
        "date": "2024-10-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 115.993
      },
      {
        "date": "2025-01-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 115.384
      },
      {
        "date": "2025-04-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 116.554
      },
      {
        "date": "2025-07-01T00:00:00",
        "realtime_end": "2026-01-26",
        "realtime_start": "2026-01-26",
        "units": null,
        "value": 117.966
      }
    ]
  },
  "title": {
    "anchor": "start",
    "color": "#2c3e50",
    "fontSize": 18,
    "fontWeight": "normal",
    "text": "Nonfarm Business Sector: Labor Productivity (Output per Hour) for All Workers"
  },
  "vconcat": [
    {
      "height": 300,
      "layer": [
        {
          "encoding": {
            "x": {
              "field": "date",
              "title": "",
              "type": "temporal"
            },
            "y": {
              "field": "value",
              "title": null,
              "type": "quantitative"
            }
          },
          "mark": {
            "color": "#2E86AB",
            "opacity": 0.12,
            "type": "area"
          }
        },
        {
          "encoding": {
            "x": {
              "axis": {
                "format": "%Y",
                "labelColor": "#555",
                "labelFontSize": 11
              },
              "field": "date",
              "title": "",
              "type": "temporal"
            },
            "y": {
              "field": "value",
              "title": null,
              "type": "quantitative"
            }
          },
          "mark": {
            "color": "#2E86AB",
            "strokeWidth": 3,
            "type": "line"
          }
        }
      ],
      "width": 800
    }
  ]
};

        function computeAxisFormat(startISO, endISO){
            const start = new Date(startISO);
            const end = new Date(endISO);
            const days = (end - start) / (1000*60*60*24);
            if(days <= 90) return "%b %d, %Y"; // ~3 months -> show day
            if(days <= 365) return "%b %Y"; // ~1 year -> show month+year
            return "%Y"; // multi-year -> show year only
        }

        // Compute global Y domain from the embedded dataset so presets can keep y-scale fixed
        const __DATA_NAME__ = (originalSpec.data && originalSpec.data.name) ? originalSpec.data.name : null;
        let GLOBAL_Y_DOMAIN = null;
        if(__DATA_NAME__ && originalSpec.datasets && originalSpec.datasets[__DATA_NAME__]){
            const vals = originalSpec.datasets[__DATA_NAME__].map(d => {
                const v = d.value;
                return (v === null || v === undefined) ? NaN : Number(v);
            }).filter(v => !isNaN(v));
            if(vals.length){
                const ymin = Math.min.apply(null, vals);
                const ymax = Math.max.apply(null, vals);
                GLOBAL_Y_DOMAIN = [ymin, ymax];
            }
        }
        // Capture original axis titles to preserve them when we modify the spec
        let ORIGINAL_X_TITLE = null;
        let ORIGINAL_Y_TITLE = null;
        try{
            if(originalSpec.vconcat && originalSpec.vconcat.length>0){
                const layers = originalSpec.vconcat[0].layer || [];
                for(let i=0;i<layers.length;i++){
                    const enc = layers[i].encoding || {};
                    if(!ORIGINAL_Y_TITLE && enc.y){
                        ORIGINAL_Y_TITLE = enc.y.title || (enc.y.axis && enc.y.axis.title) || null;
                    }
                    if(!ORIGINAL_X_TITLE && enc.x){
                        ORIGINAL_X_TITLE = enc.x.title || (enc.x.axis && enc.x.axis.title) || null;
                    }
                }
                // fallback to vconcat[1] (timeline) x title
                if(!ORIGINAL_X_TITLE && originalSpec.vconcat[1] && originalSpec.vconcat[1].encoding && originalSpec.vconcat[1].encoding.x){
                    ORIGINAL_X_TITLE = originalSpec.vconcat[1].encoding.x.title || (originalSpec.vconcat[1].encoding.x.axis && originalSpec.vconcat[1].encoding.x.axis.title) || null;
                }
            }
        }catch(e){}

        function toSpecWithRange(months){
            const spec = JSON.parse(JSON.stringify(originalSpec));
            // Remove any bound params (scale bindings) so explicit domains take effect
            if(spec.params) delete spec.params;

            if(months === 'all'){
                // default to year ticks
                if(spec.vconcat && spec.vconcat.length>0){
                    spec.vconcat[0].layer.forEach(l => {
                        if(l.encoding && l.encoding.x){
                            if(!l.encoding.x.axis) l.encoding.x.axis = {};
                            l.encoding.x.axis.format = "%Y";
                            if(l.encoding.x.scale) delete l.encoding.x.scale;
                        }
                    });
                    if(spec.vconcat[1] && spec.vconcat[1].encoding && spec.vconcat[1].encoding.x && spec.vconcat[1].encoding.x.axis) {
                        spec.vconcat[1].encoding.x.axis.format = "%Y";
                        if(spec.vconcat[1].encoding.x.scale) delete spec.vconcat[1].encoding.x.scale;
                    }
                }
                updateRangeLabel(null, null);
                return spec;
            }

            const end = new Date();
            const start = new Date(end);
            start.setMonth(end.getMonth() - Number(months));
            const startISO = start.toISOString().slice(0,19);
            const endISO = end.toISOString().slice(0,19);

            // Filter each layer's data to the selected date range so the chart updates reliably
            if(spec.vconcat && spec.vconcat.length>0){
                spec.vconcat[0].layer.forEach(l => {
                    if(l.encoding && l.encoding.x){
                        // remove any layer transform (filter) to avoid expression incompatibilities
                        if(l.transform) delete l.transform;
                        // set explicit scale domain so the view zooms to the selected range
                        if(!l.encoding.x.scale) l.encoding.x.scale = {};
                        l.encoding.x.scale.domain = [startISO, endISO];
                        // fix y-scale to global domain so zooming doesn't rescale Y
                        if(GLOBAL_Y_DOMAIN){
                            if(!l.encoding.y) l.encoding.y = {};
                            if(!l.encoding.y.scale) l.encoding.y.scale = {};
                            l.encoding.y.scale.domain = GLOBAL_Y_DOMAIN;
                        }
                        // Ensure axis titles are preserved
                        if(l.encoding.x){
                            if(!l.encoding.x.axis) l.encoding.x.axis = {};
                            if(ORIGINAL_X_TITLE) l.encoding.x.axis.title = ORIGINAL_X_TITLE;
                        }
                        if(l.encoding.y){
                            if(!l.encoding.y.axis) l.encoding.y.axis = {};
                            if(ORIGINAL_Y_TITLE) l.encoding.y.axis.title = ORIGINAL_Y_TITLE;
                        }
                    }
                });
                if(spec.vconcat[1] && spec.vconcat[1].encoding && spec.vconcat[1].encoding.x){
                    if(spec.vconcat[1].transform) delete spec.vconcat[1].transform;
                    if(!spec.vconcat[1].encoding.x.scale) spec.vconcat[1].encoding.x.scale = {};
                    spec.vconcat[1].encoding.x.scale.domain = [startISO, endISO];
                    if(GLOBAL_Y_DOMAIN){
                        if(!spec.vconcat[1].encoding.y) spec.vconcat[1].encoding.y = {};
                        if(!spec.vconcat[1].encoding.y.scale) spec.vconcat[1].encoding.y.scale = {};
                        spec.vconcat[1].encoding.y.scale.domain = GLOBAL_Y_DOMAIN;
                        // preserve axis titles for timeline if present
                        if(spec.vconcat[1].encoding.x){
                            if(!spec.vconcat[1].encoding.x.axis) spec.vconcat[1].encoding.x.axis = {};
                            if(ORIGINAL_X_TITLE) spec.vconcat[1].encoding.x.axis.title = ORIGINAL_X_TITLE;
                        }
                        if(spec.vconcat[1].encoding.y){
                            if(!spec.vconcat[1].encoding.y.axis) spec.vconcat[1].encoding.y.axis = {};
                            if(ORIGINAL_Y_TITLE) spec.vconcat[1].encoding.y.axis.title = ORIGINAL_Y_TITLE;
                        }
                    }
                }
            }
            const fmt = computeAxisFormat(startISO, endISO);
            // Apply axis format to main chart and timeline
            if(spec.vconcat && spec.vconcat.length>0){
                spec.vconcat[0].layer.forEach(l => {
                    if(l.encoding && l.encoding.x){
                        if(!l.encoding.x.axis) l.encoding.x.axis = {};
                        l.encoding.x.axis.format = fmt;
                    }
                });
                if(spec.vconcat[1] && spec.vconcat[1].encoding && spec.vconcat[1].encoding.x && spec.vconcat[1].encoding.x.axis) spec.vconcat[1].encoding.x.axis.format = fmt;
            }
            updateRangeLabel(startISO, endISO);
            return spec;
        }

        function formatShortDate(iso){
            if(!iso) return '';
            const d = new Date(iso);
            return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
        }

        function updateRangeLabel(startISO, endISO){
            const el = document.getElementById('range-label');
            if(!el) return;
            if(!startISO || !endISO) { el.textContent = ''; return; }
            el.textContent = `Showing: ${formatShortDate(startISO)} â€” ${formatShortDate(endISO)}`;
        }

        function render(spec){
            vegaEmbed('#vis', spec, {
                actions: false,
                renderer: 'svg'
            }).catch(console.error);
        }

        // Hook up buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Button active-state handling
            const buttons = document.querySelectorAll('#preset-buttons button');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const r = btn.dataset.range;
                    const s = toSpecWithRange(r);
                    render(s);
                });
            });
            // default active for 'All'
            buttons[buttons.length-1].classList.add('active');

            // Initial render
            render(originalSpec);

            // Handle window resize by re-rendering current spec
            window.addEventListener('resize', () => {
                render(originalSpec);
            });
        });
    </script>
</body>
</html>